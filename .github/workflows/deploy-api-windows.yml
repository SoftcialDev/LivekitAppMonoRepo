name: Build, Zip & Deploy ‚Äì livekit-agent-azure-func

on:
  push:
    branches:
      - main
    paths:
      - 'apps/api-functions/**'
      - '.github/workflows/main_livekit-agent-azure-func.yml'
  workflow_dispatch:

env:
  FUNC_SRC: apps/api-functions      # folder containing host.json, functions code, node_modules, etc.
  NODE_VER: '20.x'                  # Node.js version to use

permissions:
  contents: read
  id-token: write

jobs:
  build:
    runs-on: windows-latest
    permissions:
      contents: read
    env:
      DATABASE_URL: ${{ secrets.DATABASE_URL }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VER }}

      - name: Install deps, build & generate Prisma client
        shell: pwsh
        run: |
          Push-Location ${{ env.FUNC_SRC }}
          npm ci
          npm run build
          npm run prisma:generate
          if (-Not (Test-Path ".\node_modules\.prisma\client")) {
            Write-Error "‚ùå Prisma Client was not generated"
            Exit 1
          }
          Pop-Location

      - name: Package deployable ZIP
        shell: pwsh
        run: |
          Remove-Item -Force deploy.zip -ErrorAction Ignore
          Compress-Archive -Path ${{ env.FUNC_SRC }}\* -DestinationPath deploy.zip -Force

      - name: Validate ZIP contents
        shell: pwsh
        run: |
          Remove-Item -Recurse -Force zip-temp -ErrorAction Ignore
          Expand-Archive -Path deploy.zip -DestinationPath zip-temp -Force
          if (-Not (Test-Path "zip-temp/host.json")) {
            Write-Error "‚ùå host.json is missing in ZIP root"
            Exit 1
          }
          if (Test-Path "zip-temp/apps/api-functions") {
            Write-Error "‚ùå ZIP contains nested apps/api-functions folder"
            Exit 1
          }
          if (-Not (Test-Path "zip-temp/node_modules/.prisma/client")) {
            Write-Error "‚ùå node_modules/.prisma/client is missing in ZIP"
            Exit 1
          }
          Write-Host "‚úÖ ZIP structure is valid"
          Remove-Item -Recurse -Force zip-temp

      - name: Upload deploy.zip artifact
        uses: actions/upload-artifact@v4
        with:
          name: function-zip
          path: deploy.zip

  deploy:
    runs-on: windows-latest
    needs: build
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Download deploy.zip artifact
        uses: actions/download-artifact@v4
        with:
          name: function-zip
          path: .

      - name: Find deploy.zip
        id: findzip
        shell: pwsh
        run: |
          $zip = Get-ChildItem -Path . -Filter deploy.zip -Recurse |
                 Select-Object -First 1 -ExpandProperty FullName
          if (-Not (Test-Path $zip)) {
            Write-Error "‚ùå deploy.zip not found"
            Exit 1
          }
     
          "path=$zip" | Out-File -FilePath $Env:GITHUB_OUTPUT -Encoding utf8 -Append


      - name: Login to Azure (Service Principal)
        uses: azure/login@v2
        with:
          client-id:       ${{ secrets.AZURE_API_CLIENT_ID }}
          tenant-id:       ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Deploy ZIP to Azure Function
        shell: pwsh
        run: |
          az functionapp deployment source config-zip `
            --resource-group in-contact-app `
            --name livekit-agent-azure-func `
            --src "${{ steps.findzip.outputs.path }}"

      - name: Wait for Function App to be ready
        shell: pwsh
        run: |
          Write-Host "‚è≥ Waiting 60 seconds for Function App to initialize and endpoint to be available..."
          Start-Sleep -Seconds 60

      - name: Run Database Migrations
        shell: pwsh
        env:
          API_URL: ${{ secrets.API_URL }}
          API_SCOPE_URI: ${{ secrets.VITE_AZURE_AD_API_SCOPE_URI }}
        run: |
          $ErrorActionPreference = "Stop"
          
          if (-not $env:API_URL) {
            Write-Error "‚ùå VITE_API_URL secret is not set"
            exit 1
          }
          
          if (-not $env:API_SCOPE_URI) {
            Write-Error "‚ùå VITE_AZURE_AD_API_SCOPE_URI secret is not set"
            exit 1
          }
          
          # Remove /access_as_user suffix if present to get the App ID URI
          $APP_ID_URI = $env:API_SCOPE_URI -replace '/access_as_user$', ''
          
          Write-Host "üîê Obtaining Azure AD token for resource: $APP_ID_URI"
          
          # Get Azure AD access token
          $tokenResult = az account get-access-token `
            --resource "$APP_ID_URI" `
            --query accessToken `
            --output tsv
          
          if (-not $tokenResult -or $tokenResult -eq "") {
            Write-Error "‚ùå Failed to obtain Azure AD token"
            exit 1
          }
          
          $token = $tokenResult
          Write-Host "‚úÖ Token obtained successfully"
          
          # Build migration endpoint URL
          $migrationUrl = "$env:API_URL/api/RunMigrations"
          if (-not $migrationUrl.StartsWith("http")) {
            $migrationUrl = "https://$migrationUrl"
          }
          
          Write-Host "üîÑ Calling migration endpoint: $migrationUrl"
          
          # Retry configuration
          $maxRetries = 5
          $retryDelay = 30  # seconds
          $success = $false
          $lastError = $null
          
          for ($attempt = 1; $attempt -le $maxRetries; $attempt++) {
            try {
              Write-Host "üìû Attempt $attempt of $maxRetries..."
              
              $headers = @{
                "Authorization" = "Bearer $token"
                "Content-Type" = "application/json"
              }
              
              $body = @{} | ConvertTo-Json
              
              $response = Invoke-RestMethod `
                -Uri $migrationUrl `
                -Method Post `
                -Headers $headers `
                -Body $body `
                -ContentType "application/json" `
                -ErrorAction Stop
              
              Write-Host "‚úÖ Migrations completed successfully"
              Write-Host "Response: $($response | ConvertTo-Json -Depth 3)"
              $success = $true
              break
              
            } catch {
              $lastError = $_
              $statusCode = $_.Exception.Response.StatusCode.value__
              
              if ($statusCode -eq 404 -or $statusCode -eq 503) {
                Write-Warning "‚ö†Ô∏è  Endpoint not ready yet (HTTP $statusCode). Waiting $retryDelay seconds before retry..."
                if ($attempt -lt $maxRetries) {
                  Start-Sleep -Seconds $retryDelay
                }
              } else {
                Write-Error "‚ùå Migration failed with HTTP $statusCode"
                Write-Error "Error: $($_.Exception.Message)"
                if ($_.Exception.Response) {
                  $reader = New-Object System.IO.StreamReader($_.Exception.Response.GetResponseStream())
                  $responseBody = $reader.ReadToEnd()
                  Write-Error "Response body: $responseBody"
                }
                exit 1
              }
            }
          }
          
          if (-not $success) {
            Write-Error "‚ùå Migration failed after $maxRetries attempts"
            Write-Error "Last error: $lastError"
            exit 1
          }
